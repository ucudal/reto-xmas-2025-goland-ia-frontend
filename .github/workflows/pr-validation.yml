name: PR Validation

on:
  pull_request:
    branches:
      - main

jobs:
  build-image:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image (no push)
        uses: docker/build-push-action@v5
        with:
          context: .
          platforms: linux/amd64
          push: false
          tags: crretoxmas2024.azurecr.io/goland-frontend:pr-${{ github.event.pull_request.number }}
          cache-from: type=registry,ref=crretoxmas2024.azurecr.io/goland-frontend:buildcache
          cache-to: type=inline

  gitleaks:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run Gitleaks
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITLEAKS_LICENSE: ${{ secrets.GITLEAKS_LICENSE || '' }}
        continue-on-error: true

  sonarqube:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run SonarQube analysis
        uses: sonarsource/sonarqube-scan-action@master
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONARQUBE_TOKEN }}
          SONAR_HOST_URL: https://sonarqube.reto-ucu.net
          SONAR_PROJECT_KEY: goland-frontend
        with:
          args: >
            -Dsonar.branch.name=${{ github.head_ref }}
            -Dsonar.pullrequest.base=${{ github.base_ref }}
            -Dsonar.pullrequest.branch=${{ github.head_ref }}
            -Dsonar.pullrequest.key=${{ github.event.pull_request.number }}

  trivy-scan:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image for scanning
        uses: docker/build-push-action@v5
        with:
          context: .
          platforms: linux/amd64
          push: false
          tags: goland-frontend:pr-scan
          load: true

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: goland-frontend:pr-scan
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH'
          exit-code: '0'
          ignore-unfixed: true

      - name: Upload Trivy results to GitHub Security
        uses: github/codeql-action/upload-sarif@v2
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'

  notify-discord-pr:
    runs-on: ubuntu-latest
    needs: [build-image, gitleaks, trivy-scan, sonarqube]
    if: always()
    steps:
      - name: Notify Discord - PR Ready
        if: success()
        uses: sarisia/actions-status-discord@v1
        with:
          webhook: ${{ secrets.DISCORD_WEBHOOK }}
          title: "üîç PR Validation - Goland Frontend"
          description: "PR #${{ github.event.pull_request.number }}: ${{ github.event.pull_request.title }}"
          color: 0x00ff00
          username: "GitHub Actions"
          fields: |
            [
              {"name": "Author", "value": "${{ github.event.pull_request.user.login }}", "inline": true},
              {"name": "Branch", "value": "${{ github.head_ref }}", "inline": true},
              {"name": "Status", "value": "‚úÖ All checks passed", "inline": false},
              {"name": "PR Link", "value": "${{ github.event.pull_request.html_url }}", "inline": false}
            ]

      - name: Notify Discord - PR Failed
        if: failure()
        uses: sarisia/actions-status-discord@v1
        with:
          webhook: ${{ secrets.DISCORD_WEBHOOK }}
          title: "‚ùå PR Validation Failed - Goland Frontend"
          description: "PR #${{ github.event.pull_request.number }}: ${{ github.event.pull_request.title }}"
          color: 0xff0000
          username: "GitHub Actions"
          fields: |
            [
              {"name": "Author", "value": "${{ github.event.pull_request.user.login }}", "inline": true},
              {"name": "Branch", "value": "${{ github.head_ref }}", "inline": true},
              {"name": "Status", "value": "‚ùå Some checks failed", "inline": false},
              {"name": "PR Link", "value": "${{ github.event.pull_request.html_url }}", "inline": false}
            ]

